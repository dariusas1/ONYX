# =============================================================================
# ONYX Production Environment Configuration with Docker Secrets
# =============================================================================
# Production environment using Docker secrets for secure credential management
# Use with: docker compose -f docker-compose.yaml -f docker-compose.secrets.yaml up
# =============================================================================

# =============================================================================
# IMPORTANT SECURITY NOTES:
# =============================================================================
# - This file references Docker secrets, not environment variables
# - Secrets are created with: docker secret create <name> <file>
# - Never commit actual secret values to version control
# - Use external secret management for production (HashiCorp Vault, AWS SM, etc.)
# =============================================================================

services:
  # Frontend - Next.js 14 with Suna UI
  suna:
    environment:
      # Remove ALL sensitive environment variables, use secrets instead
      NODE_ENV: production
      NEXT_PUBLIC_API_BASE: "/"
      REDIS_URL: "redis://redis:6379"
      QDRANT_URL: "http://qdrant:6333"
      LITELLM_URL: "http://litellm-proxy:4000"
      LOG_LEVEL: info
      LOG_FORMAT: json
      NEXT_PUBLIC_LOG_LEVEL: info
      NEXT_PUBLIC_SERVICE_NAME: suna-frontend
      NEXT_PUBLIC_ENABLE_REMOTE_LOGGING: "true"
    secrets:
      - google_client_id
      - google_client_secret
      - session_secret

  # Python RAG service
  onyx-core:
    environment:
      # Keep non-sensitive environment variables only
      PYTHONPATH: /app
      QDRANT_URL: "http://qdrant:6333"
      REDIS_URL: "redis://redis:6379"
      LOG_LEVEL: info
      LOG_FORMAT: json
      SERVICE_NAME: onyx-core
      PYTHON_ENV: production
    secrets:
      - google_client_id
      - google_client_secret
      - encryption_key
      - session_secret
      - qdrant_api_key
      - postgres_password

  # PostgreSQL database
  postgres:
    environment:
      # Override with secret file reference
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password
      # Keep non-sensitive environment variables
      POSTGRES_DB: manus
      POSTGRES_USER: manus
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8"
    secrets:
      - postgres_password

  # Redis cache + job queue
  redis:
    command: redis-server --requirepass-file /run/secrets/redis_password
    secrets:
      - redis_password

  # Qdrant vector database
  qdrant:
    environment:
      # Override with secret file reference
      QDRANT__SERVICE__API_KEY_FILE: /run/secrets/qdrant_api_key
      # Keep non-sensitive environment variables
      QDRANT__SERVICE__HTTP_PORT: 6333
      QDRANT__SERVICE__GRPC_PORT: 6334
    secrets:
      - qdrant_api_key

  # LiteLLM proxy for LLM routing
  litellm-proxy:
    environment:
      # Remove sensitive API keys from environment, use secrets instead
      LITELLM_PORT: 4000
      LITELLM_MODEL_LIST: |
        model_list:
          - model_name: "deepseek-main"
            litellm_params:
              model: "together/deepseek-chat"
          - model_name: "ollama-fallback"
            litellm_params:
              model: "ollama/mistral:latest"
              api_base: "http://ollama:11434"
    secrets:
      - together_api_key
      - deepseek_api_key

  # Grafana dashboards
  grafana:
    environment:
      # Override with secret file reference
      GF_SECURITY_ADMIN_PASSWORD_FILE: /run/secrets/grafana_password
      # Keep non-sensitive environment variables
      GF_USERS_ALLOW_SIGN_UP: false
    secrets:
      - grafana_password

# =============================================================================
# Docker Secrets Configuration
# =============================================================================
# Secrets are created externally and mounted as files in /run/secrets/
# Example commands:
#   echo "your-google-client-id" | docker secret create google_client_id -
#   echo "your-postgres-password" | docker secret create postgres_password -
# =============================================================================
secrets:
  google_client_id:
    external: true
  google_client_secret:
    external: true
  session_secret:
    external: true
  encryption_key:
    external: true
  qdrant_api_key:
    external: true
  postgres_password:
    external: true
  redis_password:
    external: true
  together_api_key:
    external: true
  deepseek_api_key:
    external: true
  grafana_password:
    external: true

# =============================================================================
# Production Deployment Instructions:
# =============================================================================
# 1. Create all secrets with actual values:
#    docker secret create <name> <file-or-stdin>
#
# 2. Deploy with secrets:
#    docker compose -f docker-compose.yaml -f docker-compose.secrets.yaml up -d
#
# 3. Verify secrets are not exposed:
#    docker compose -f docker-compose.yaml -f docker-compose.secrets.yaml config --no-path-resolution | grep -v "password\|key\|secret"
#
# 4. Check secret access in containers:
#    docker compose exec onyx-core cat /run/secrets/google_client_secret
# =============================================================================