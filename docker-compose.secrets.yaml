# =============================================================================
# ONYX Production Docker Secrets Configuration
# =============================================================================
# This file demonstrates how to use Docker secrets for production deployment
# Use with: docker compose -f docker-compose.yaml -f docker-compose.secrets.yaml up
# =============================================================================

services:
  # Override services to use Docker secrets instead of environment variables
  suna:
    environment:
      # Remove sensitive environment variables, use secrets instead
      NODE_ENV: production
      NEXT_PUBLIC_API_BASE: "/"
      LOG_FORMAT: json
      NEXT_PUBLIC_SERVICE_NAME: suna-frontend
      NEXT_PUBLIC_ENABLE_REMOTE_LOGGING: "true"
    secrets:
      - postgres_password
      - together_api_key
      - deepseek_api_key
      - google_client_id
      - google_client_secret
      - encryption_key
      - session_secret

  onyx-core:
    environment:
      # Keep non-sensitive environment variables
      PYTHONPATH: /app
      LOG_FORMAT: json
      DATABASE_URL: "postgresql://manus:${POSTGRES_PASSWORD}@postgres:5432/manus"
      REDIS_URL: "redis://redis:6379"
      QDRANT_URL: "http://qdrant:6333"
      LITELLM_URL: "http://litellm-proxy:4000"
    secrets:
      - postgres_password
      - redis_password
      - qdrant_api_key
      - encryption_key
      - session_secret

  postgres:
    environment:
      POSTGRES_DB: manus
      POSTGRES_USER: manus
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password
    secrets:
      - postgres_password

  redis:
    command: redis-server --requirepass ${REDIS_PASSWORD}
    secrets:
      - redis_password

  qdrant:
    environment:
      QDRANT__SERVICE__API_KEY_FILE: /run/secrets/qdrant_api_key
    secrets:
      - qdrant_api_key

  litellm-proxy:
    environment:
      LITELLM_PROXY_KEY: ${LITELLM_PROXY_KEY}
    secrets:
      - together_api_key
      - deepseek_api_key

  grafana:
    environment:
      GF_SECURITY_ADMIN_PASSWORD_FILE: /run/secrets/grafana_password
    secrets:
      - grafana_password

# Define the secrets
secrets:
  postgres_password:
    external: true
  redis_password:
    external: true
  qdrant_api_key:
    external: true
  together_api_key:
    external: true
  deepseek_api_key:
    external: true
  google_client_id:
    external: true
  google_client_secret:
    external: true
  encryption_key:
    external: true
  session_secret:
    external: true
  grafana_password:
    external: true