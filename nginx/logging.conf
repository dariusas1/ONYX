# =============================================================================
# ONYX Nginx Logging Configuration
# =============================================================================

# JSON log format for structured logging
log_format json_combined escape=json
    '{'
    '"timestamp": "$time_iso8601",'
    '"method": "$request_method",'
    '"uri": "$request_uri",'
    '"status": $status,'
    '"bytes_sent": $body_bytes_sent,'
    '"referer": "$http_referer",'
    '"user_agent": "$http_user_agent",'
    '"remote_addr": "$remote_addr",'
    '"request_time": $request_time,'
    '"upstream_connect_time": "$upstream_connect_time",'
    '"upstream_header_time": "$upstream_header_time",'
    '"upstream_response_time": "$upstream_response_time",'
    '"upstream_addr": "$upstream_addr",'
    '"upstream_status": "$upstream_status",'
    '"request_id": "$request_id",'
    '"scheme": "$scheme",'
    '"host": "$host",'
    '"server_name": "$server_name"'
    '}';

# Error log format (JSON)
log_format json_error escape=json
    '{'
    '"timestamp": "$time_iso8601",'
    '"level": "error",'
    '"message": "$message",'
    '"pid": $pid,'
    '"tid": $tid,'
    '"cid": $connection,'
    '"extra": "$client"'
    '}';

# Access logs with JSON format
access_log /var/log/nginx/access.log json_combined;

# Error logs with JSON format  
error_log /var/log/nginx/error.log warn;

# Rate limiting logs
limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=login:10m rate=1r/s;

# Log buffering for performance
access_log /var/log/nginx/access.log json_combined buffer=32k flush=1m;

# Conditional logging (skip health checks)
map $status $loggable {
    ~^[23]  0;
    default 1;
}

# Skip logging for health checks
map $uri $health_check {
    ~/health          0;
    ~/health/ready     0;
    ~/health/live      0;
    default           1;
}

# Apply conditional logging
access_log /var/log/nginx/access.log json_combined if=$loggable;
access_log /var/log/nginx/access.log json_combined if=$health_check;