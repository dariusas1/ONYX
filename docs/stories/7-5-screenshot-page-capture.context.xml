<?xml version="1.0" encoding="UTF-8"?>
<story-context id="{bmad_folder}/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>epic-7</epicId>
    <storyId>7-5</storyId>
    <title>Screenshot &amp; Page Capture</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-16T19:05:00Z</generatedAt>
    <generator>BMAD Story Context Workflow (simulated)</generator>
    <sourceStoryPath>docs/stories/7-5-screenshot-page-capture.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>automation agent</asA>
    <iWant>capture high-fidelity screenshots of dynamic web pages with configurable resolution</iWant>
    <soThat>I can document UI state, audit automation results, and share visual context with downstream workflows</soThat>
    <tasks>- Task 1: Screenshot tool contract (AC: #1, #4)
  - [ ] Subtask 1.1: Define screenshot tool schema (url, format, full_page, width, height)
  - [ ] Subtask 1.2: Implement FastAPI request/response models with validation + examples
  - [ ] Subtask 1.3: Register tool with ToolRegistry for Agent Mode discovery

- Task 2: Navigation + wait strategies (AC: #2)
  - [ ] Subtask 2.1: Reuse BrowserManager navigate(wait_until="networkidle")
  - [ ] Subtask 2.2: Add timeout + security validation (block local/internal URLs)
  - [ ] Subtask 2.3: Surface navigation telemetry in logs/metrics

- Task 3: Capture pipeline (AC: #3, #5)
  - [ ] Subtask 3.1: Support full-page + viewport captures
  - [ ] Subtask 3.2: Allow custom viewport sizing with bounds + fallback to defaults
  - [ ] Subtask 3.3: Provide cropping guard rails for >20000px documents

- Task 4: Encoding + output (AC: #4, #7)
  - [ ] Subtask 4.1: Encode PNG + JPEG with configurable quality
  - [ ] Subtask 4.2: Return base64 plus optional Drive storage URL (defer upload toggle for now)
  - [ ] Subtask 4.3: Attach metadata (dimensions, file size, capture timestamp)

- Task 5: Performance + SLA (AC: #6)
  - [ ] Subtask 5.1: Track navigation + capture duration ensuring &lt;5s target
  - [ ] Subtask 5.2: Emit structured logs for slow captures and errors
  - [ ] Subtask 5.3: Guard memory usage when capturing huge pages

- Task 6: Testing (All ACs)
  - [ ] Subtask 6.1: Unit tests for request validation/sanitization
  - [ ] Subtask 6.2: Service tests mocking BrowserManager screenshot outputs
  - [ ] Subtask 6.3: API tests verifying JSON contract + error propagation
  - [ ] Subtask 6.4: Performance smoke tests for <5s guarantee</tasks>
  </story>

  <acceptanceCriteria>1. **AC7.5.1**: Agent can invoke screenshot tool with URL parameter
2. **AC7.5.2**: Browser navigates and waits for page load completion
3. **AC7.5.3**: Full page screenshot captured (entire scrollHeight)
4. **AC7.5.4**: Image returned as base64 or stored in Drive with URL
5. **AC7.5.5**: Resolution configurable (default: 1920x1080)
6. **AC7.5.6**: Execution time &lt;5s for screenshot capture
7. **AC7.5.7**: Supports PNG (lossless) and JPEG (smaller file size) formats</acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics/epic-7-tech-spec.md</path>
        <title>Epic 7 Technical Specification</title>
        <section>Story 7.5 Requirements</section>
        <snippet>Describes screenshot tool API, performance targets, supported formats, and audit obligations.</snippet>
      </doc>
      <doc>
        <path>docs/stories/7-1-playwright-browser-setup-headless-automation.context.xml</path>
        <title>Story 7.1 Context</title>
        <section>Browser Foundation</section>
        <snippet>BrowserManager configuration, serialization locks, and navigation helpers reused by screenshot service.</snippet>
      </doc>
      <doc>
        <path>docs/stories/7-4-form-filling-web-interaction.context.xml</path>
        <title>Story 7.4 Context</title>
        <section>Audit Artifact Patterns</section>
        <snippet>Details screenshot capture + Drive storage strategy leveraged for screenshot workflow.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-status.yaml</path>
        <title>Sprint Tracker</title>
        <section>Epic 7</section>
        <snippet>Authoritative story metadata: dependencies, priority, AC mapping, expected status transitions.</snippet>
      </doc>
    </docs>
    <code>
      <code>
        <path>onyx-core/services/browser_manager.py</path>
        <kind>service</kind>
        <symbol>BrowserManager</symbol>
        <lines>1-420</lines>
        <reason>Provides navigation, screenshot capture, and serial execution primitives needed for screenshot tool.</reason>
      </code>
      <code>
        <path>onyx-core/api/web_tools.py</path>
        <kind>router</kind>
        <symbol>APIRouter</symbol>
        <lines>1-560</lines>
        <reason>Existing web automation router where screenshot endpoint will be added alongside scrape/fill_form.</reason>
      </code>
      <code>
        <path>onyx-core/services/form_fill_service.py</path>
        <kind>service</kind>
        <symbol>FormFillService</symbol>
        <lines>1-260</lines>
        <reason>Provides reference for structured audit payloads, screenshot capture helpers, and warning propagation.</reason>
      </code>
      <code>
        <path>onyx-core/services/tool_registry.py</path>
        <kind>service</kind>
        <symbol>ToolRegistry</symbol>
        <lines>1-220</lines>
        <reason>Tool registration patterns to follow when exposing screenshot capability to agents.</reason>
      </code>
    </code>
    <dependencies>
      <python>
        <package name="playwright" version="1.41.1">Headless browser automation for screenshot capture</package>
        <package name="pydantic" version="2.6.1">Request/response validation for screenshot endpoint</package>
        <package name="fastapi" version="0.111.0">API layer for exposing screenshot tool</package>
      </python>
    </dependencies>
  </artifacts>

  <interfaces>
    <interface>
      <name>screenshot tool contract</name>
      <kind>tool</kind>
      <signature>screenshot(url: HttpUrl, full_page: bool = True, width: int = 1920, height: int = 1080, format: Literal('png','jpeg') = 'png')</signature>
      <path>onyx-core/api/web_tools.py</path>
      <description>Agent-facing schema for requesting screenshots with configurable resolution and output format.</description>
    </interface>
    <interface>
      <name>BrowserManager.screenshot</name>
      <kind>method</kind>
      <signature>async def screenshot(self, page: Page, full_page: bool = True) -&gt; bytes</signature>
      <path>onyx-core/services/browser_manager.py</path>
      <description>Existing helper to capture PNG bytes; will be extended for JPEG + custom viewport sizing.</description>
    </interface>
  </interfaces>

  <tests>
    <standards>Reuse pytest + asyncio fixtures from Story 7.4. Mock BrowserManager during unit tests to avoid Playwright dependency. Verify JSON contract fields, metadata, and warnings. Include performance assertions ensuring reported execution time &lt;5s for typical page heights (â‰¤6000px).</standards>
    <locations>
      <location>onyx-core/tests/test_api/test_web_tools.py</location>
      <location>onyx-core/tests/test_services/test_screenshot_service.py</location>
      <location>tests/performance/test_screenshot_capture.py</location>
    </locations>
    <ideas>
      <idea ac="AC7.5.1">Invoke screenshot tool with valid URL and ensure success true with base64 output</idea>
      <idea ac="AC7.5.2">Simulate slow page load and ensure BrowserManager wait strategy handles DOM completion</idea>
      <idea ac="AC7.5.3">Validate full-page capture returns taller height than viewport when content scrolls</idea>
      <idea ac="AC7.5.4">Verify Drive upload toggle returns storage URL when enabled and base64 always present</idea>
      <idea ac="AC7.5.5">Ensure width/height overrides applied to BrowserManager viewport config</idea>
      <idea ac="AC7.5.6">Measure execution_time_ms metadata &lt;5000 for standard fixtures</idea>
      <idea ac="AC7.5.7">Request PNG vs JPEG and assert MIME info + size differences in response</idea>
    </ideas>
  </tests>
</story-context>
