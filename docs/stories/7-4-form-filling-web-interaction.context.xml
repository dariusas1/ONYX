<?xml version="1.0" encoding="UTF-8"?>
<context xmlns="http://www.bmad.dev/schema/context"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://www.bmad.dev/schema/context ../../../../.bmad/schemas/context.xsd">

    <!-- Story 7-4: Form Filling &amp; Web Interaction Context -->
    <metadata>
        <story-id>7-4</story-id>
        <story-title>Form Filling &amp; Web Interaction</story-title>
        <epic>7 - Web Automation Tools</epic>
        <status>ready-for-dev</status>
        <last-updated>2025-01-14</last-updated>
        <dependencies>
            <dependency story="7-1">Playwright Browser Setup (Headless Automation)</dependency>
            <dependency story="7-2">Web Search Tool (SerpAPI, Exa)</dependency>
        </dependencies>
    </metadata>

    <!-- Story Requirements Summary -->
    <requirements>
        <primary-goal>Implement robust form filling and web interaction capabilities that leverage existing browser automation infrastructure and integrate with search capabilities</primary-go>

        <core-capabilities>
            <capability id="form-detection">
                <name>Intelligent Form Field Detection</name>
                <description>Automatically identify and categorize form fields (text inputs, checkboxes, radio buttons, dropdowns, file uploads)</description>
                <priority>high</priority>
            </capability>

            <capability id="form-filling">
                <name>Automated Form Submission</name>
                <description>Fill forms with provided data and submit with validation handling</description>
                <priority>high</priority>
            </capability>

            <capability id="web-interaction">
                <name>Advanced Web Interactions</name>
                <description>Handle complex web interactions including dropdowns, modals, multi-step forms, and dynamic content</description>
                <priority>medium</priority>
            </capability>

            <capability id="search-integration">
                <name>Search-Enhanced Form Filling</name>
                <description>Integrate with web search tools to auto-fill forms using publicly available information</description>
                <priority>medium</priority>
            </capability>

            <capability id="error-handling">
                <name>Robust Error Handling</name>
                <description>Graceful handling of form validation errors, CAPTCHAs, and dynamic content changes</description>
                <priority>high</priority>
            </capability>
        </core-capabilities>
    </requirements>

    <!-- Technical Architecture Integration -->
    <architecture>
        <base-infrastructure>
            <component ref="browser-automation" from-story="7-1">
                <usage>Utilizes Playwright browser instances for form interaction</usage>
                <integration-points>
                    <point>Browser instance management and lifecycle</point>
                    <point>Headless Chrome/Firefox execution</point>
                    <point>Docker containerization support</point>
                </integration-points>
            </component>

            <component ref="search-capabilities" from-story="7-2">
                <usage>Web search integration for intelligent form field population</usage>
                <integration-points>
                    <point>SerpAPI integration for real-time web search</point>
                    <point>Exa search for precise information retrieval</point>
                    <point>Rate limiting and caching coordination</point>
                </integration-points>
            </component>
        </base-infrastructure>

        <new-components>
            <component id="form-analyzer">
                <name>Form Structure Analyzer</name>
                <purpose>Analyze HTML forms and create interaction models</purpose>
                <technology>Playwright DOM inspection + Custom parsing logic</technology>
            </component>

            <component id="interaction-engine">
                <name>Web Interaction Engine</name>
                <purpose>Execute form filling and interaction sequences</purpose>
                <technology>Playwright automation + Error handling orchestration</technology>
            </component>

            <component id="data-mapper">
                <name>Form Data Mapping Service</name>
                <purpose>Map provided data to form fields intelligently</purpose>
                <technology>Field matching algorithms + Search integration</technology>
            </component>
        </new-components>
    </architecture>

    <!-- Dependencies Context -->
    <dependencies-context>
        <from-story-7-1>
            <browser-setup>
                <playwright-version>1.40.0+</playwright-version>
                <supported-browsers>Chromium, Firefox, WebKit</supported-browsers>
                <docker-support>
                    <base-image>mcr.microsoft.com/playwright:v1.40.0</base-image>
                    <headless-operation>true</headless-operation>
                    <performance-requirements>2GB RAM, 2 CPU cores minimum</performance-requirements>
                </docker-support>
            </browser-setup>

            <available-apis>
                <browser-management>launch, close, new page, page management</browser-management>
                <page-interactions>click, type, select, upload, navigate</page-interactions>
                <dom-inspection>element queries, attributes, text content</dom-inspection>
                <javascript-execution>evaluate scripts, custom functions</javascript-execution>
            </available-apis>

            <error-handling-patterns>
                <timeouts>configurable wait and timeout strategies</timeouts>
                <selectors>robust element selection strategies</selectors>
                <recovery>automatic retry mechanisms</recovery>
            </error-handling-patterns>
        </from-story-7-1>

        <from-story-7-2>
            <search-integration>
                <serpapi-capabilities>
                    <real-time-search>current web information retrieval</real-time-search>
                    <structured-results>parsed search results with metadata</structured-results>
                    <rate-limits>100 requests/month for default plan</rate-limits>
                </serpapi-capabilities>

                <exa-capabilities>
                    <precise-search>advanced semantic search capabilities</precise-search>
                    <content-extraction>deep content analysis and extraction</content-extraction>
                    <api-management>request throttling and error handling</api-management>
                </exa-capabilities>

                <caching-strategy>
                    <memory-cache>Redis-based caching for frequent queries</memory-cache>
                    <ttl-management>configurable cache expiration</ttl-management>
                    <cache-invalidation>intelligent cache refresh</cache-invalidation>
                </caching-strategy>
            </search-integration>
        </from-story-7-2>
    </dependencies-context>

    <!-- Implementation Patterns -->
    <implementation-patterns>
        <form-detection-pattern>
            <description>Use Playwright's DOM inspection to identify form elements and create field maps</description>
            <steps>
                <step>Locate all &lt;form&gt; elements on the page</step>
                <step>Analyze form structure and field types</step>
                <step>Extract field metadata (name, type, required, validation)</step>
                <step>Create interaction model for form filling</step>
            </steps>
        </form-detection-pattern>

        <intelligent-filling-pattern>
            <description>Combine provided data with search-enhanced data collection for comprehensive form filling</description>
            <steps>
                <step>Map provided data to form fields</step>
                <step>Identify missing required information</step>
                <step>Use search integration to find missing data</step>
                <step>Validate and format data according to field requirements</step>
                <step>Execute form filling with error handling</step>
            </steps>
        </intelligent-filling-pattern>

        <error-recovery-pattern>
            <description>Implement robust error handling for dynamic web content and validation failures</description>
            <steps>
                <step>Detect form validation errors after submission</step>
                <step>Analyze error messages and field requirements</step>
                <step>Adjust data and retry submission</step>
                <step>Handle CAPTCHAs and anti-bot measures</step>
                <step>Log interactions for debugging and improvement</step>
            </steps>
        </error-recovery-pattern>
    </implementation-patterns>

    <!-- API Integration Points -->
    <api-integrations>
        <internal-apis>
            <api name="browser-service">
                <source>Story 7-1</source>
                <usage>Launch and manage browser instances for form interaction</usage>
                <endpoints>
                    <endpoint>POST /browser/launch</endpoint>
                    <endpoint>POST /browser/page/navigate</endpoint>
                    <endpoint>POST /browser/page/interact</endpoint>
                    <endpoint>GET /browser/page/content</endpoint>
                </endpoints>
            </api>

            <api name="search-service">
                <source>Story 7-2</source>
                <usage>Retrieve information for intelligent form field population</usage>
                <endpoints>
                    <endpoint>POST /search/web</endpoint>
                    <endpoint>POST /search/precise</endpoint>
                    <endpoint>GET /search/cache</endpoint>
                </endpoints>
            </api>
        </internal-apis>

        <external-apis>
            <api name="serpapi">
                <usage>Real-time web search for form data enhancement</usage>
                <rate-limits>100 requests/month</rate-limits>
                <authentication>API key required</authentication>
            </api>

            <api name="exa">
                <usage>Precise semantic search for complex data requirements</usage>
                <rate-limits>1000 requests/month</rate-limits>
                <authentication>API key required</authentication>
            </api>
        </external-apis>
    </api-integrations>

    <!-- Configuration Requirements -->
    <configuration>
        <form-filling-config>
            <timeouts>
                <element-wait>30 seconds</element-wait>
                <form-submission>60 seconds</form-submission>
                <page-load>30 seconds</page-load>
            </timeouts>

            <retry-strategy>
                <max-attempts>3</max-attempts>
                <backoff-strategy>exponential</backoff-strategy>
                <base-delay>1 second</base-delay>
            </retry-strategy>

            <field-matching>
                <fuzzy-matching>true</fuzzy-matching>
                <similarity-threshold>0.8</similarity-threshold>
                <name-variations>email, e-mail, email_address</name-variations>
            </field-matching>
        </form-filling-config>

        <search-integration-config>
            <cache-ttl>3600 seconds</cache-ttl>
            <max-search-attempts>2</max-search-attempts>
            <confidence-threshold>0.7</confidence-threshold>
        </search-integration-config>
    </configuration>

    <!-- Testing Strategy -->
    <testing-requirements>
        <unit-tests>
            <component>Form field detection and parsing</component>
            <component>Data mapping and validation</component>
            <component>Error handling and recovery logic</component>
        </unit-tests>

        <integration-tests>
            <component>Browser service integration</component>
            <component>Search service integration</component>
            <component>End-to-end form filling workflows</component>
        </integration-tests>

        <e2e-tests>
            <scenario>Simple contact form filling</scenario>
            <scenario>Multi-step registration form</scenario>
            <scenario>Dynamic form with validation</scenario>
            <scenario>File upload forms</scenario>
            <scenario>Search-enhanced form filling</scenario>
        </e2e-tests>
    </testing-requirements>

    <!-- Performance Considerations -->
    <performance-requirements>
        <response-times>
            <form-detection>&lt; 5 seconds</form-detection>
            <form-filling>&lt; 30 seconds</form-filling>
            <search-enhancement>&lt; 10 seconds</search-enhancement>
        </response-times>

        <resource-usage>
            <memory-impact>Minimal additional memory usage (leveraging existing browser instances)</memory-impact>
            <cpu-impact>Efficient DOM parsing and interaction patterns</cpu-impact>
        </resource-usage>

        <scalability>
            <concurrent-forms>Support for multiple concurrent form filling operations</concurrent-forms>
            <browser-reuse>Efficient browser instance reuse across multiple forms</browser-reuse>
        </scalability>
    </performance-requirements>

    <!-- Security Considerations -->
    <security-requirements>
        <data-protection>
            <sensitive-data>Secure handling of personal information in forms</sensitive-data>
            <data-sanitization>Input sanitization and validation</data-sanitization>
            <logging>Secure logging practices avoiding sensitive data exposure</logging>
        </data-protection>

        <api-security>
            <credential-management>Secure storage of API keys for search services</credential-management>
            <rate-limiting>Respect external API rate limits and quotas</rate-limiting>
        </api-security>

        <browser-security>
            <sandbox-isolation>Browser sandbox isolation for form interactions</sandbox-isolation>
            <web-security>Adherence to web security best practices (CORS, CSP, etc.)</web-security>
        </browser-security>
    </security-requirements>

    <!-- Deployment Considerations -->
    <deployment-requirements>
        <containerization>
            <docker-integration>Seamless integration with existing Docker setup from Story 7-1</docker-integration>
            <resource-allocation>Efficient resource usage within containerized environment</resource-allocation>
        </containerization>

        <monitoring>
            <form-interaction-metrics>Track form filling success rates and performance</form-interaction-metrics>
            <error-monitoring>Comprehensive error tracking and alerting</error-monitoring>
            <api-usage-monitoring>Monitor external API usage and quotas</api-usage-monitoring>
        </monitoring>
    </deployment-requirements>

    <!-- Success Criteria -->
    <success-criteria>
        <functional>
            <criterion>Successfully detect and analyze 95% of standard web forms</criterion>
            <criterion>Fill forms with 90% accuracy using provided data</criterion>
            <criterion>Integrate with search services for intelligent data population</criterion>
            <criterion>Handle common form validation scenarios gracefully</criterion>
        </functional>

        <performance>
            <criterion>Complete form filling within 30 seconds for average forms</criterion>
            <criterion>Maintain browser instance reuse efficiency above 80%</criterion>
            <criterion>Search enhancement adds less than 10 seconds to total time</criterion>
        </performance>

        <reliability>
            <criterion>Handle dynamic content and AJAX forms reliably</criterion>
            <criterion>Recover from common interaction failures automatically</criterion>
            <criterion>Maintain 99% uptime for form filling operations</criterion>
        </reliability>
    </success-criteria>
</context>