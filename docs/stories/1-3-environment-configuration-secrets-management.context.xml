<?xml version="1.0" encoding="UTF-8"?>
<story-context>
  <metadata>
    <story-id>1-3-environment-configuration-secrets-management</story-id>
    <story-title>Environment Configuration &amp; Secrets Management</story-title>
    <status>ready-for-dev</status>
    <epic>Epic 1: Foundation &amp; Infrastructure</epic>
    <developer-model>Claude-3.5-Sonnet (2024-10-22)</developer-model>
    <context-generated>2025-11-14T20:00:00Z</context-generated>
  </metadata>

  <critical-security-alerts>
    <alert id="1" severity="critical">
      <title>Complete Secrets Masking Failure</title>
      <description>Docker Compose ${VAR} substitution does NOT mask secrets - docker compose config exposes all credentials</description>
      <impact>Production deployment would expose all API keys and passwords</impact>
      <required-fix>Replace environment variable approach with proper Docker secrets</required-fix>
    </alert>
    <alert id="2" severity="high">
      <title>False Security Implementation</title>
      <description>Current validation scripts only test empty values, not actual secret masking</description>
      <impact>Team thinks secrets are protected when they're actually exposed</impact>
      <required-fix>Update test scripts to validate with actual secret values</required-fix>
    </alert>
  </critical-security-alerts>

  <acceptance-criteria>
    <ac id="1">
      <given>.env.example in repo with all required variables</given>
      <when>Dev creates .env.local (git-ignored)</when>
      <then>docker compose up loads environment variables into containers</then>
    </ac>
    <ac id="2">
      <given>Environment variables configured</given>
      <when>docker compose up runs</when>
      <then>No secrets appear in Docker images</then>
    </ac>
    <ac id="3">
      <given>Services running with environment variables</given>
      <when>docker compose config executed</when>
      <then>Shows masked secrets</then>
    </ac>
    <ac id="4">
      <given>Multiple environment configurations</given>
      <when>Using different .env.* files</when>
      <then>Different .env.* files work for dev/staging/prod</then>
    </ac>
  </acceptance-criteria>

  <architecture-overview>
    <deployment-target>Docker Compose on Hostinger KVM 4 VPS</deployment-target>
    <service-count>11 core services</service-count>
    <security-requirements>
      <requirement>All API keys encrypted at rest using AES-256</requirement>
      <requirement>No credentials in Docker images or git history</requirement>
      <requirement>Environment-specific separation (dev/staging/prod)</requirement>
      <requirement>Docker Compose env_file directive for secure loading</requirement>
    </security-requirements>
  </architecture-overview>

  <current-state-analysis>
    <existing-files>
      <file path=".env.example" status="complete">
        <description>Comprehensive template with 105 lines covering all required variables</description>
        <coverage>Google OAuth, LLM APIs, Database, Redis, Qdrant, Encryption, Monitoring, Features</coverage>
      </file>
      <file path=".env.logging" status="complete">
        <description>Structured logging configuration with JSON format</description>
        <usage>Base pattern for environment variable organization</usage>
      </file>
      <file path="docker-compose.yaml" status="partial">
        <description>11 services configured but missing env_file directives</description>
        <issue>Environment variables hardcoded in environment sections</issue>
        <services>suna, onyx-core, postgres, redis, qdrant, litellm-proxy, ollama, nginx, prometheus, grafana</services>
      </file>
      <file path="nginx/nginx.conf" status="complete">
        <description>Reverse proxy with SSL, rate limiting, CORS configured</description>
        <integration>Ready for environment variable support</integration>
      </file>
      <file path=".gitignore" status="complete">
        <description>Properly excludes .env.local, .env.production, .env.staging</description>
      </file>
    </existing-files>

    <gaps-identified>
      <gap priority="critical">SECRETS MASKING COMPLETELY BROKEN - docker compose config exposes all credentials</gap>
      <gap priority="critical">Current implementation provides false sense of security</gap>
      <gap priority="high">Docker Compose env_file directives implemented but secrets still exposed</gap>
      <gap priority="high">Production deployment blocked by security vulnerabilities</gap>
      <gap priority="medium">No environment-specific .env.* templates (.env.staging, .env.prod)</gap>
      <gap priority="medium">Validation scripts only test empty values, not actual secret masking</gap>
      <gap priority="low">Missing proper Docker secrets implementation for production</gap>
    </gaps-identified>
  </current-state-analysis>

  <technical-specifications>
    <required-environment-variables source="architecture.md Appendix">
      <category name="Google OAuth">
        <var name="GOOGLE_CLIENT_ID" required="true" description="OAuth2 client ID from Google Cloud Console"/>
        <var name="GOOGLE_CLIENT_SECRET" required="true" description="OAuth2 client secret"/>
        <var name="GOOGLE_REDIRECT_URI" required="true" description="Callback URL for OAuth flow"/>
      </category>
      <category name="LLM Configuration">
        <var name="TOGETHER_API_KEY" required="true" description="Together AI API key for DeepSeek"/>
        <var name="DEEPSEEK_API_KEY" required="true" description="DeepSeek API key (alternative to Together)"/>
        <var name="DEEPSEEK_MODEL" required="false" default="together/deepseek-chat" description="Model identifier"/>
        <var name="OLLAMA_BASE_URL" required="false" default="http://ollama:11434" description="Fallback LLM endpoint"/>
      </category>
      <category name="Database">
        <var name="DATABASE_URL" required="true" description="PostgreSQL connection string"/>
        <var name="POSTGRES_PASSWORD" required="true" description="Postgres admin password"/>
        <var name="POSTGRES_DB" required="false" default="manus" description="Database name"/>
        <var name="POSTGRES_USER" required="false" default="manus" description="Database user"/>
      </category>
      <category name="Redis">
        <var name="REDIS_URL" required="true" description="Redis connection string"/>
        <var name="REDIS_PASSWORD" required="false" description="Redis authentication password"/>
      </category>
      <category name="Qdrant">
        <var name="QDRANT_URL" required="true" description="Qdrant vector DB endpoint"/>
        <var name="QDRANT_API_KEY" required="false" description="Qdrant authentication key"/>
      </category>
      <category name="Security">
        <var name="ENCRYPTION_KEY" required="true" description="32-byte hex string for AES-256"/>
        <var name="SESSION_SECRET" required="true" description="Session encryption secret"/>
      </category>
      <category name="Monitoring">
        <var name="GRAFANA_PASSWORD" required="true" description="Grafana admin password"/>
      </category>
      <category name="Features">
        <var name="ENABLE_WORKSPACE" required="false" default="true" description="Enable VNC workspace"/>
        <var name="ENABLE_CODE_EXECUTION" required="false" default="true" description="Enable code execution"/>
        <var name="ENABLE_GOOGLE_DRIVE" required="false" default="true" description="Enable Google Drive integration"/>
        <var name="ENABLE_SLACK" required="false" default="true" description="Enable Slack integration"/>
      </category>
    </required-environment-variables>

    <docker-compose-integration>
      <env_file-directive>
        <description>Add env_file directive to all 11 services</description>
        <pattern>env_file: - .env.local</pattern>
        <precedence>env_file overrides environment section variables</precedence>
      </env_file-directive>
      <service-specific-requirements>
        <service name="suna">
          <env-vars>NODE_ENV, NEXT_PUBLIC_API_BASE, DATABASE_URL, REDIS_URL, QDRANT_URL, LITELLM_URL</env-vars>
          <logging>LOG_LEVEL, LOG_FORMAT, NEXT_PUBLIC_SERVICE_NAME</logging>
        </service>
        <service name="onyx-core">
          <env-vars>DATABASE_URL, QDRANT_URL, REDIS_URL, GOOGLE_CLIENT_ID, GOOGLE_CLIENT_SECRET, ENCRYPTION_KEY</env-vars>
          <logging>LOG_LEVEL, LOG_FORMAT, SERVICE_NAME, PYTHONPATH</logging>
        </service>
        <service name="postgres">
          <env-vars>POSTGRES_DB, POSTGRES_USER, POSTGRES_PASSWORD</env-vars>
        </service>
        <service name="redis">
          <env-vars>REDIS_PASSWORD (optional)</env-vars>
        </service>
        <service name="litellm-proxy">
          <env-vars>TOGETHER_API_KEY, DEEPSEEK_API_KEY</env-vars>
        </service>
        <service name="grafana">
          <env-vars>GF_SECURITY_ADMIN_PASSWORD</env-vars>
        </service>
      </service-specific-requirements>
    </docker-compose-integration>

    <security-implementation>
      <secrets-masking>
        <docker-compose-config>docker compose config should show ${VAR_NAME} instead of actual values</docker-compose-config>
        <validation>Test with docker compose config | grep -v "password\|key\|secret"</validation>
      </secrets-masking>
      <git-history-protection>
        <validation-script>git log -S "password\|secret\|key" --oneline</validation-script>
        <pre-commit-hook>Check for sensitive patterns before commit</pre-commit-hook>
      </git-history-protection>
      <encryption-requirements>
        <method>AES-256 encryption for stored credentials</method>
        <key-generation>openssl rand -hex 32 for ENCRYPTION_KEY</key-generation>
      </encryption-requirements>
    </security-implementation>
  </technical-specifications>

  <implementation-tasks>
    <task id="1" title="Create comprehensive .env.example template" ac="1">
      <subtask id="1.1">Verify all required variables from architecture appendix are included</subtask>
      <subtask id="1.2">Add descriptions and default values where appropriate</subtask>
      <subtask id="1.3">Include security notes for sensitive variables</subtask>
      <subtask id="1.4">Test .env.example completeness by starting all services</subtask>
    </task>
    
    <task id="2" title="Configure Docker Compose environment file loading" ac="2,3">
      <subtask id="2.1">Update docker-compose.yaml with env_file directives for all services</subtask>
      <subtask id="2.2">Ensure service-specific environment variables are properly scoped</subtask>
      <subtask id="2.3">Test environment variable injection into containers</subtask>
      <subtask id="2.4">Verify all 11 services start with correct environment configuration</subtask>
      <subtask id="2.5">Test environment variable precedence (env_file vs environment section)</subtask>
    </task>
    
    <task id="3" title="Implement secrets masking and security" ac="4,5">
      <subtask id="3.1">Ensure secrets are not exposed in docker images</subtask>
      <subtask id="3.2">Configure docker compose config to mask sensitive values</subtask>
      <subtask id="3.3">Add validation script to check for secrets in git history</subtask>
      <subtask id="3.4">Test docker compose config output for proper masking</subtask>
      <subtask id="3.5">Verify no secrets in container environment inspection</subtask>
    </task>
    
    <task id="4" title="Support multiple environment configurations" ac="6">
      <subtask id="4.1">Create .env.local, .env.staging, .env.prod templates</subtask>
      <subtask id="4.2">Add environment switching mechanism</subtask>
      <subtask id="4.3">Document environment-specific variable requirements</subtask>
      <subtask id="4.4">Test environment switching functionality</subtask>
      <subtask id="4.5">Create environment validation script</subtask>
    </task>
  </implementation-tasks>

  <testing-strategy>
    <unit-tests>
      <test>Verify environment variable loading in each container</test>
      <test>Validate docker compose config output masking</test>
      <test>Test environment variable precedence</test>
    </unit-tests>
    <integration-tests>
      <test>Start all services with .env.local configuration</test>
      <test>Test service-to-service communication with env vars</test>
      <test>Verify secrets not exposed in docker inspect</test>
    </integration-tests>
    <security-tests>
      <test>Check git history for committed secrets</test>
      <test>Validate docker image layers for sensitive data</test>
      <test>Test environment file permissions and access</test>
    </security-tests>
  </testing-strategy>

  <validation-checklist>
    <item id="v1">.env.example contains all required variables with descriptions</item>
    <item id="v2">docker-compose.yaml includes env_file directive for all services</item>
    <item id="v3">docker compose config masks sensitive values</item>
    <item id="v4">All services start successfully with .env.local</item>
    <item id="v5">No secrets found in git history</item>
    <item id="v6">Environment switching works for dev/staging/prod</item>
    <item id="v7">Container environment inspection shows proper variables</item>
    <item id="v8">Docker images contain no hardcoded secrets</item>
  </validation-checklist>

  <references>
    <reference type="architecture" path="docs/architecture.md" sections="Security Architecture, Implementation Patterns, Appendix Environment Variables"/>
    <reference type="epics" path="docs/epics.md" sections="Story 1.3 Environment Configuration &amp; Secrets Management"/>
    <reference type="story-1-1" path=".bmad-ephemeral/stories/1-1-project-setup-repository-initialization.md"/>
    <reference type="story-1-2" path=".bmad-ephemeral/stories/1-2-nginx-reverse-proxy-configuration.md"/>
    <reference type="docker-compose" path="docker-compose.yaml"/>
    <reference type="env-example" path=".env.example"/>
    <reference type="env-logging" path=".env.logging"/>
    <reference type="nginx-config" path="nginx/nginx.conf"/>
  </references>

  <learnings-from-previous-stories>
    <learning story="1-2">
      <insight>SSL certificates implemented in nginx/ssl/ directory - ensure environment variables support SSL paths</insight>
      <insight>Structured JSON logging configured (.env.logging) - extend this pattern for all environment variables</insight>
      <insight>Docker Compose foundation established with 11 core services - build environment configuration on existing service definitions</insight>
    </learning>
    <unresolved-items>
      <item priority="low">Configure non-root users for production containers - consider CONTAINER_USER environment variable</item>
      <item priority="low">Add missing REDIS_PASSWORD default - ensure all environment variables have proper defaults</item>
      <item priority="low">Implement actual database connectivity checks - ensure environment variables support health check configuration</item>
    </unresolved-items>
  </learnings-from-previous-stories>

  <dev-guidance>
    <approach>
      <step>1. Update docker-compose.yaml to add env_file directives to all services</step>
      <step>2. Test environment variable loading with existing .env.example</step>
      <step>3. Create environment-specific templates (.env.staging, .env.prod)</step>
      <step>4. Implement secrets masking validation</step>
      <step>5. Create environment switching documentation and scripts</step>
    </approach>
    
    <key-considerations>
      <consideration>Maintain backward compatibility with existing environment sections</consideration>
      <consideration>Ensure all 11 services receive required environment variables</consideration>
      <consideration>Test environment variable precedence (env_file overrides environment section)</consideration>
      <consideration>Validate no secrets in Docker images or git history</consideration>
      <consideration>Document environment switching for dev/staging/prod workflows</consideration>
    </key-considerations>

    <success-criteria>
      <criteria>All services start with docker compose up using .env.local</criteria>
      <criteria>docker compose config shows masked secrets (${VAR_NAME})</criteria>
      <criteria>Multiple environment configurations work seamlessly</criteria>
      <criteria>No secrets committed to git or embedded in images</criteria>
      <criteria>Comprehensive documentation for environment management</criteria>
    </success-criteria>
  </dev-guidance>
</story-context>